<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>MIDI â†’ ãƒ‰ãƒ¬ãƒŸä»˜ã MusicXML å¤‰æ›</title>
<style>
body { font-family: sans-serif; padding: 2em; background: #f7f7f7; }
h1 { color: #333; }
pre { white-space: pre-wrap; font-family: monospace; }
button { margin-top: 1em; padding: 0.6em 1.2em; border: none; background: #0078d7; color: white; border-radius: 6px; cursor: pointer; }
button:hover { background: #005ea6; }
</style>
</head>
<body>
<h1>ğŸµ MIDI â†’ ãƒ‰ãƒ¬ãƒŸä»˜ã MusicXML å¤‰æ›</h1>
<input type="file" id="fileInput" accept=".mid,.midi" />
<button id="convertBtn">å¤‰æ›</button>
<a id="downloadLink" style="display:none;">score_doremi.xml ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
<pre id="preview"></pre>

<script src="https://cdn.jsdelivr.net/npm/midi-parser-js/dist/MidiParser.min.js"></script>
<script>
function midiNoteToPitch(noteNum) {
  const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const step = names[noteNum % 12];
  const octave = Math.floor(noteNum / 12) - 1;
  return { step, octave };
}

function toDoremi(step, octave) {
  const map = {C:"ãƒ‰", "C#":"ãƒ‰#", D:"ãƒ¬", "D#":"ãƒ¬#", E:"ãƒŸ", F:"ãƒ•ã‚¡", "F#":"ãƒ•ã‚¡#", G:"ã‚½", "G#":"ã‚½#", A:"ãƒ©", "A#":"ãƒ©#", B:"ã‚·"};
  const name = map[step] || step;
  if (octave < 4) return name + "\nï¼¿";  // ä½ã„éŸ³
  if (octave > 5) return "ï¼¿\n" + name; // é«˜ã„éŸ³
  return name;
}

document.getElementById("convertBtn").onclick = () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

  const reader = new FileReader();
  reader.onload = e => {
    const midi = MidiParser.parse(e.target.result);

    let xml = `<?xml version="1.0" encoding="UTF-8"?>
<score-partwise version="3.1">
 <part-list><score-part id="P1"><part-name>Music</part-name></score-part></part-list>
 <part id="P1">
`;

    for (let track of midi.track) {
      for (let event of track.event) {
        if (event.type === 9) { // Note on
          const { step, octave } = midiNoteToPitch(event.data[0]);
          const doremi = toDoremi(step, octave);
          xml += `
  <measure>
    <note>
      <pitch>
        <step>${step.replace("#","")}</step>
        ${step.includes("#") ? "<alter>1</alter>" : ""}
        <octave>${octave}</octave>
      </pitch>
      <duration>1</duration>
      <lyric><text>${doremi}</text></lyric>
    </note>
  </measure>`;
        }
      }
    }

    xml += "\n </part>\n</score-partwise>";
    const blob = new Blob([xml], {type: "application/xml"});
    const url = URL.createObjectURL(blob);
    const link = document.getElementById("downloadLink");
    link.href = url;
    link.download = "score_doremi.xml";
    link.style.display = "inline";
    document.getElementById("preview").textContent = xml.substring(0, 2000) + "\n...";
  };
  reader.readAsArrayBuffer(file);
};
</script>
</body>
</html>
