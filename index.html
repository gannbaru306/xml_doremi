<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>xmlâ†’ãƒ‰ãƒ¬ãƒŸä»˜ãæ¥½è­œv2.1</title>
  <style>
    body{font-family:sans-serif;padding:1.5em;background:#f4f7fb;text-align:center}
    #scoreContainer{background:#fff;border:1px solid #ccc;min-height:220px;padding:1em;margin:1em auto;max-width:900px}
    #status{white-space:pre-line;text-align:left;max-width:900px;margin:0 auto;background:#fff;border:1px solid #ddd;padding:0.6em}
    input,button{padding:0.6em 1em;margin:0.4em}
  </style>
</head>
<body>
  <h1>xmlâ†’ãƒ‰ãƒ¬ãƒŸä»˜ãæ¥½è­œv2.1</h1>

  <div>
    <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
    <button id="loadBtn">èª­ã¿è¾¼ã¿é–‹å§‹</button>
    <button id="pdfBtn">PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ä¿å­˜</button>
  </div>

  <p id="status">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ä¸­...</p>
  <div id="scoreContainer"></div>

  <!-- OSMDã¨PDFé–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…ˆã«å®Œå…¨ãƒ­ãƒ¼ãƒ‰ -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.7.6/build/opensheetmusicdisplay.min.js" onload="osmdReady()" onerror="loadError('OSMD')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="loadError('html2canvas')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="loadError('jsPDF')"></script>

  <script>
  const statusEl = document.getElementById("status");
  function logStatus(s){ statusEl.textContent = new Date().toLocaleTimeString() + " â€” " + s; }
  function loadError(name){ logStatus(`âŒ ${name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ã‹ã‚‚ï¼‰`); }

  function osmdReady(){
    if (!window.opensheetmusicdisplay?.OpenSheetMusicDisplay) {
      logStatus("âš ï¸ OSMDãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†è©¦è¡Œä¸­...");
      setTimeout(osmdReady, 700);
      return;
    }
    logStatus("âœ… OSMDãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ï¼");
    initApp();
  }

  async function initApp(){
    const container = document.getElementById("scoreContainer");
    window.jsPDF = window.jspdf?.jsPDF || window.jsPDF;

    const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container, {
      backend: "svg",
      drawingParameters: "default",
      drawTitle: true,
      drawPartNames: true,
      zoom: 1.0,
      autoResize: true,
      pageBackgroundColor: "#ffffff",
    });

    logStatus("ğŸµ åˆæœŸåŒ–å®Œäº†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€Œèª­ã¿è¾¼ã¿é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");

    // éŸ³åâ†’ãƒ‰ãƒ¬ãƒŸ
    function toDoremi(step, alter, octave){
      const base = {C:"ãƒ‰", D:"ãƒ¬", E:"ãƒŸ", F:"ãƒ•ã‚¡", G:"ã‚½", A:"ãƒ©", B:"ã‚·"};
      let name = base[step] || step;
      if (alter === 1) name += "#";
      if (alter === -1) name += "â™­";
      const offset = octave - 4 + 2;
      const supers = ["â»Â¹","â°","Â¹","Â²","Â³","â´","âµ","â¶","â·","â¸"][offset] || `(${octave})`;
      return name + supers;
    }

    function processXML(xmlText){
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "text/xml");
      const notes = xmlDoc.getElementsByTagName("note");
      let chordGroup = [];
      function flushChordGroup(){
        if (chordGroup.length <= 1) { chordGroup = []; return; }
        chordGroup.forEach((noteNode, idx) => {
          const pitch = noteNode.getElementsByTagName("pitch")[0];
          if (!pitch) return;
          const step = pitch.getElementsByTagName("step")[0]?.textContent;
          const alter = parseInt(pitch.getElementsByTagName("alter")[0]?.textContent || 0);
          const octave = parseInt(pitch.getElementsByTagName("octave")[0]?.textContent || 4);
          const lyricText = toDoremi(step, alter, octave);
          const lyric = xmlDoc.createElement("lyric");
          lyric.setAttribute("number", idx + 1);
          const text = xmlDoc.createElement("text");
          text.textContent = lyricText;
          lyric.appendChild(text);
          noteNode.appendChild(lyric);
        });
        chordGroup = [];
      }
      for (let i=0; i<notes.length; i++){
        const n = notes[i];
        const isChord = n.getElementsByTagName("chord").length > 0;
        if (!isChord){ flushChordGroup(); chordGroup = [n]; }
        else { chordGroup.push(n); }
      }
      flushChordGroup();
      return new XMLSerializer().serializeToString(xmlDoc);
    }

    document.getElementById("loadBtn").addEventListener("click", () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file){ logStatus("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          if (file.name.endsWith(".mxl")) await osmd.load(e.target.result);
          else await osmd.load(processXML(e.target.result));
          await osmd.render();
          logStatus("ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†");
        } catch(err){
          logStatus("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err);
        }
      };
      if (file.name.endsWith(".mxl")) reader.readAsArrayBuffer(file);
      else reader.readAsText(file, "UTF-8");
    });

    // === PDFç”Ÿæˆï¼ˆæ¯”ç‡ç¶­æŒï¼‰ ===
    document.getElementById("pdfBtn").addEventListener("click", async () => {
      try {
        const svg = container.querySelector("svg");
        if (!svg) return logStatus("æ¥½è­œãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");

        logStatus("PDFç”Ÿæˆä¸­...");

        const rect = svg.getBoundingClientRect();
        const svgWidth = rect.width;
        const svgHeight = rect.height;

        const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const scale = Math.min(pageWidth / svgWidth, pageHeight / svgHeight);
        const renderWidth = svgWidth * scale;
        const renderHeight = svgHeight * scale;
        const xOffset = (pageWidth - renderWidth) / 2;
        const yOffset = (pageHeight - renderHeight) / 2;

        const svgData = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.crossOrigin = "anonymous";

        img.onload = function(){
          const canvas = document.createElement("canvas");
          const DPR = 2;
          canvas.width = renderWidth * DPR;
          canvas.height = renderHeight * DPR;
          const ctx = canvas.getContext("2d");
          ctx.scale(DPR, DPR);
          ctx.drawImage(img, 0, 0, renderWidth, renderHeight);
          const imgData = canvas.toDataURL("image/png", 1.0);
          pdf.addImage(imgData, "PNG", xOffset, yOffset, renderWidth, renderHeight);
          pdf.save("score.pdf");
          URL.revokeObjectURL(url);
          logStatus("PDFä¿å­˜å®Œäº†");
        };
        img.onerror = ()=>logStatus("SVGç”»åƒåŒ–å¤±æ•—");
        img.src = url;

      } catch(e){ logStatus("PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼: "+e); }
    });
  }
  </script>
</body>
</html>
