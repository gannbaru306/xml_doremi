<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>xml→ドレミ付き楽譜生成 by gannbaru306</title>
  <style>
    body{font-family:sans-serif;padding:1.5em;background:#f4f7fb;text-align:center}
    #scoreContainer{background:#fff;border:1px solid #ccc;min-height:220px;padding:1em;margin:1em auto;max-width:900px}
    #status{white-space:pre-line;text-align:left;max-width:900px;margin:0 auto;background:#fff;border:1px solid #ddd;padding:0.6em}
    input,button{padding:0.6em 1em;margin:0.4em}
  </style>
</head>
<body>
  <h1>xml→ドレミ付き楽譜v2</h1>

  <div>
    <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
    <button id="loadBtn">読み込み開始</button>
    <button id="pdfBtn">PDFプレビュー / 保存</button>
  </div>

  <p id="status">読み込み待機中</p>
  <div id="scoreContainer"></div>

  <!-- ライブラリ -->
  <script src="https://unpkg.com/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("status");
  function logStatus(s){ statusEl.textContent = (new Date()).toLocaleTimeString() + " — " + s; }

  logStatus("ライブラリ読み込みチェック中...");

  // OSMDを待つループ
  const waitForOSMD = setInterval(() => {
    if (window.opensheetmusicdisplay) {
      clearInterval(waitForOSMD);
      logStatus("OSMDロード完了！初期化を開始します...");
      initApp();
    } else {
      logStatus("OSMDを読み込み中...（通信待機）");
    }
  }, 700);

  async function initApp(){
    logStatus("OSMD初期化中...");
    const container = document.getElementById("scoreContainer");

    // Safari対策
    window.jsPDF = window.jspdf?.jsPDF || window.jsPDF;
    let osmd;
    try {
      osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container);
      logStatus("OSMD初期化完了。ファイルを選択して「読み込み開始」を押してください。");
    } catch(err){
      logStatus("エラー: OSMD初期化失敗\n" + err);
      return;
    }

    // ドレミ変換
    function toDoremi(step, alter, octave){
      const base = {C:"ド", D:"レ", E:"ミ", F:"ファ", G:"ソ", A:"ラ", B:"シ"};
      let name = base[step] || step;
      if (alter === 1) name += "#";
      if (alter === -1) name += "♭";
      const offset = octave - 4 + 2;
      const supers = ["⁻¹","⁰","¹","²","³","⁴","⁵","⁶","⁷","⁸"][offset] || `(${octave})`;
      return name + supers;
    }

    // XML加工
   function processXML(xmlText){
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "text/xml");
  if (xmlDoc.getElementsByTagName("parsererror").length)
    throw new Error("XML parse error");

  const notes = xmlDoc.getElementsByTagName("note");
  let chordGroup = []; // 和音を一時的に保持するバッファ

  function flushChordGroup() {
    if (chordGroup.length <= 1) {
      chordGroup = [];
      return;
    }

    // 縦並び（上から下）
    chordGroup.forEach((noteNode, idx) => {
      const pitch = noteNode.getElementsByTagName("pitch")[0];
      if (!pitch) return;
      const step = pitch.getElementsByTagName("step")[0]?.textContent;
      const alter = parseInt(pitch.getElementsByTagName("alter")[0]?.textContent || 0);
      const octave = parseInt(pitch.getElementsByTagName("octave")[0]?.textContent || 4);
      const lyricText = toDoremi(step, alter, octave);

      const lyric = xmlDoc.createElement("lyric");
      lyric.setAttribute("number", idx + 1);
      const text = xmlDoc.createElement("text");
      text.textContent = lyricText;
      lyric.appendChild(text);
      noteNode.appendChild(lyric);
    });
    chordGroup = [];
  }

  for (let i = 0; i < notes.length; i++) {
    const n = notes[i];
    const isChord = n.getElementsByTagName("chord").length > 0;

    if (!isChord) {
      // 前の和音があれば確定
      flushChordGroup();
      chordGroup = [n];
    } else {
      chordGroup.push(n);
    }
  }

  // 最後の和音グループを出力
  flushChordGroup();

  return new XMLSerializer().serializeToString(xmlDoc);
}

    // 読み込みボタン
    const fileInput = document.getElementById("fileInput");
    const loadBtn = document.getElementById("loadBtn");

    loadBtn.addEventListener("click", () => {
      const file = fileInput.files[0];
      if(!file){ logStatus("ファイルを選択してください。"); return; }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          if (file.name.endsWith(".mxl")) {
            await osmd.load(e.target.result);
          } else {
            const processedXml = processXML(e.target.result);
            await osmd.load(processedXml);
          }
          await osmd.render();
          logStatus("レンダリング完了！");
        } catch(err){
          logStatus("読み込みエラー:\n" + err);
        }
      };

      if (file.name.endsWith(".mxl"))
        reader.readAsArrayBuffer(file);
      else
        reader.readAsText(file,"UTF-8");
    });

    // PDFボタン
    document.getElementById("pdfBtn").addEventListener("click", async () => {
      try {
        const svg = container.querySelector("svg");
        if (!svg) { logStatus("まだ楽譜がありません。"); return; }

        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], { type: "image/svg+xml" });
        const svgUrl = URL.createObjectURL(svgBlob);
        const img = new Image();

        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const png = canvas.toDataURL("image/png");

          const PDF = window.jsPDF;
          if (!PDF) { logStatus("jsPDFが利用できません。"); return; }

          const pdf = new PDF({orientation:"portrait",unit:"px"});
          const pageWidth = pdf.internal.pageSize.getWidth();
          const scale = pageWidth / img.width;
          pdf.addImage(png, "PNG", 0, 0, pageWidth, img.height * scale);
          pdf.save("score.pdf");
          logStatus("PDF保存完了！");
          URL.revokeObjectURL(svgUrl);
        };
        img.src = svgUrl;
      } catch(e){
        logStatus("PDF生成エラー: " + e);
      }
    });
  }
});
</script>
</body>
</html>
