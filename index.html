<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ドレミ付き楽譜 ヘルパー診断版</title>
  <style>
    body{font-family:sans-serif;padding:1.5em;background:#f4f7fb;text-align:center}
    #scoreContainer{background:#fff;border:1px solid #ccc;min-height:220px;padding:1em;margin:1em auto;max-width:900px}
    #status{white-space:pre-line;text-align:left;max-width:900px;margin:0 auto;background:#fff;border:1px solid #ddd;padding:0.6em}
    input,button{padding:0.6em 1em;margin:0.4em}
  </style>
</head>
<body>
  <h1>ドレミ付き楽譜 — 診断版</h1>

  <div>
    <!-- 透明にして重ねる方式は避ける（iPadの不具合回避） -->
    <input type="file" id="fileInput" accept=".xml,.musicxml" />
    <button id="loadBtn">読み込み開始</button>
    <button id="pdfBtn">PDFプレビュー / 保存</button>
  </div>

  <p id="status">ステータス：待機中</p>

  <div id="scoreContainer"></div>

  <!-- ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.6.4/build/opensheetmusicdisplay.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("status");
  function logStatus(s){ statusEl.textContent = (new Date()).toLocaleTimeString() + " — " + s; }

  // Safari対応でjsPDFを確保
  try {
    window.jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : window.jsPDF;
  } catch(e){
    // nothing
  }

  logStatus("ライブラリ読み込みチェック中...");

  // ライブラリ存在チェック（見える化）
  if(!window.opensheetmusicdisplay){
    logStatus("エラー: OpenSheetMusicDisplay が読み込まれていません。ネット接続を確認してください。");
    return;
  }
  if(!window.html2canvas){
    logStatus("エラー: html2canvas が読み込まれていません。");
    return;
  }
  if(!window.jspdf && !window.jsPDF){
    logStatus("警告: jsPDF が見つかりません（PDF機能は制限されます）。");
  } else {
    logStatus("ライブラリ読み込みOK。OSMD初期化します...");
  }

  // OSMD 初期化（DOM確実参照）
  let osmd;
  try {
    const container = document.getElementById("scoreContainer");
    osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container);
    logStatus("OSMD初期化完了。ファイルを選択して「読み込み開始」を押してください。");
  } catch(err){
    logStatus("エラー: OSMD初期化に失敗しました。\n" + err.toString());
    return;
  }

  // 変換ヘルパー（ドレミ付与）
  function toDoremi(step, alter, octave){
    const base = {C:"ド", D:"レ", E:"ミ", F:"ファ", G:"ソ", A:"ラ", B:"シ"};
    let name = base[step] || step;
    if (alter === 1) name += "#";
    if (alter === -1) name += "♭";
    const offset = octave - 4 + 2;
    const supers = ["⁻¹","⁰","¹","²","³","⁴","⁵","⁶","⁷","⁸"][offset] || `(${octave})`;
    return name + supers;
  }

  function processXML(xmlText){
    try{
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText,"text/xml");
      // check parseerror
      const pe = xmlDoc.getElementsByTagName("parsererror");
      if(pe.length) throw new Error("XML parse error");
      const notes = xmlDoc.getElementsByTagName("note");
      for(let i=0;i<notes.length;i++){
        const n = notes[i];
        const pitch = n.getElementsByTagName("pitch")[0];
        if(pitch){
          const step = pitch.getElementsByTagName("step")[0]?.textContent;
          const alter = parseInt(pitch.getElementsByTagName("alter")[0]?.textContent || 0);
          const octave = parseInt(pitch.getElementsByTagName("octave")[0]?.textContent || 4);
          const lyricText = toDoremi(step,alter,octave);
          const lyric = xmlDoc.createElement("lyric");
          const text = xmlDoc.createElement("text");
          text.textContent = lyricText;
          lyric.appendChild(text);
          n.appendChild(lyric);
        }
      }
      return new XMLSerializer().serializeToString(xmlDoc);
    } catch(e){
      throw new Error("processXML失敗: " + e.message);
    }
  }

  // ファイル処理
  const fileInput = document.getElementById("fileInput");
  const loadBtn = document.getElementById("loadBtn");
  loadBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if(!file){
      logStatus("ファイルが選択されていません。左のボタンで .xml/.musicxml を選んでください。");
      return;
    }
    logStatus("ファイル選択: " + file.name + " — 読み込みを開始します...");
    const reader = new FileReader();

    reader.onloadstart = () => logStatus("FileReader: 読み込み開始...");
    reader.onerror = () => logStatus("FileReader: 読み込みエラーが発生しました。ファイルを確認してください。");
    reader.onabort = () => logStatus("FileReader: 読み込みが中断されました。");
    reader.onload = async (e) => {
      try {
        logStatus("FileReader: 読み込み成功。XML処理中...");
        const processedXml = processXML(e.target.result);
        logStatus("XML加工完了。OSMDにロード中...");
        await osmd.load(processedXml);
        logStatus("OSMD.load 完了。レンダリング中...");
        await osmd.render();
        logStatus("レンダリング完了：楽譜が表示されました。 (" + file.name + ")");
      } catch(err){
        logStatus("読み込み/描画エラー:\n" + err.toString());
      }
    };

    // iPadでの文字コード問題回避
    reader.readAsText(file, "UTF-8");
  });

  // PDFボタン（プレビュー方式：iPadで保存しやすい）
  const pdfBtn = document.getElementById("pdfBtn");
  pdfBtn.addEventListener("click", async () => {
    try {
      logStatus("PDF処理：キャプチャ開始...");
      const canvas = await html2canvas(document.getElementById("scoreContainer"), {scale:2, useCORS:true});
      logStatus("キャプチャ完了。PDF生成中...");
      const jsPDFConstructor = window.jspdf?.jsPDF || window.jsPDF;
      if(!jsPDFConstructor){
        logStatus("エラー: jsPDF が利用できません。");
        return;
      }
      const pdf = new jsPDFConstructor();
      const img = canvas.toDataURL("image/png");
      const w = pdf.internal.pageSize.getWidth();
      const h = (canvas.height * w) / canvas.width;
      pdf.addImage(img, "PNG", 0, 0, w, h);
      // iPadでは保存より新タブでプレビューする方が確実
      const blob = pdf.output("blob");
      const url = URL.createObjectURL(blob);
      logStatus("PDF生成完了。別タブで開きます...");
      window.open(url);
    } catch(e){
      logStatus("PDF生成でエラー: " + e.toString());
    }
  });

});
</script>
</body>
</html>
